---
// src/pages/index.astro
import '../styles/global.css';

const title = "ğŸ§ Mandarin Number Listening Quiz";
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
            50% { box-shadow: 0 0 30px rgba(16, 185, 129, 0.5); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-slide-in {
            animation: slideIn 0.4s ease-out forwards;
        }
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        .btn-glow:hover {
            animation: pulse-glow 2s infinite;
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-slate-900 to-gray-900 min-h-screen flex items-center justify-center p-4 font-[Inter] overflow-x-hidden">
    <!-- Animated background particles -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-20 left-10 w-2 h-2 bg-cyan-400/30 rounded-full animate-float"></div>
        <div class="absolute top-40 right-20 w-3 h-3 bg-emerald-400/20 rounded-full animate-float" style="animation-delay: 0.5s"></div>
        <div class="absolute bottom-32 left-1/4 w-2 h-2 bg-purple-400/30 rounded-full animate-float" style="animation-delay: 1s"></div>
        <div class="absolute bottom-20 right-1/3 w-3 h-3 bg-pink-400/20 rounded-full animate-float" style="animation-delay: 1.5s"></div>
    </div>

    <div class="w-full max-w-lg relative z-10">
        <!-- Card Container -->
        <div class="bg-gradient-to-br from-gray-800/90 to-gray-900/90 backdrop-blur-xl rounded-3xl shadow-2xl p-6 sm:p-8 border border-gray-700/50 animate-slide-in">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="inline-block animate-float">
                    <span class="text-5xl sm:text-6xl mb-3 block">ğŸ§</span>
                </div>
                <h1 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-emerald-400 via-cyan-400 to-blue-400 bg-clip-text text-transparent">
                    Mandarin Number Quiz
                </h1>
                <p class="text-gray-400 text-sm mt-2">Practice your listening skills</p>
            </div>

            <!-- Settings Section -->
            <div id="settings-section" class="space-y-5">
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-300">
                        ğŸ“Š Maximum Range
                    </label>
                    <input 
                        type="number" 
                        id="max-range" 
                        value="1000"
                        class="w-full px-4 py-3 bg-gray-700/50 border-2 border-gray-600/50 rounded-2xl text-white placeholder-gray-500 focus:outline-none focus:border-cyan-500/50 focus:bg-gray-700/70 transition-all duration-300"
                        placeholder="e.g., 1000"
                    >
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-300">
                        ğŸ¯ Difficulty Level
                    </label>
                    <select 
                        id="difficulty" 
                        class="w-full px-4 py-3 bg-gray-700/50 border-2 border-gray-600/50 rounded-2xl text-white focus:outline-none focus:border-cyan-500/50 focus:bg-gray-700/70 transition-all duration-300 cursor-pointer"
                    >
                        <option value="easy">ğŸŸ¢ Easy - Round Numbers</option>
                        <option value="medium">ğŸŸ¡ Medium - Semi-Complex</option>
                        <option value="hard">ğŸ”´ Hard - Random Numbers</option>
                    </select>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-300">
                        ğŸ¤ Voice Selection
                    </label>
                    <select 
                        id="voice-select" 
                        class="w-full px-4 py-3 bg-gray-700/50 border-2 border-gray-600/50 rounded-2xl text-white focus:outline-none focus:border-cyan-500/50 focus:bg-gray-700/70 transition-all duration-300 cursor-pointer"
                    >
                        <option value="zh-CN-XiaoxiaoNeural">ğŸ‘© Xiaoxiao (Female) - Natural</option>
                        <option value="zh-CN-YunxiNeural">ğŸ‘¨ Yunxi (Male) - Natural</option>
                        <option value="zh-CN-YunyangNeural">ğŸ‘¨ Yunyang (Male) - Professional</option>
                        <option value="zh-CN-XiaoyiNeural">ğŸ‘© Xiaoyi (Female) - Friendly</option>
                    </select>
                </div>

                <button 
                    id="start-btn"
                    class="w-full bg-gradient-to-r from-emerald-500 via-cyan-500 to-blue-500 hover:from-emerald-600 hover:via-cyan-600 hover:to-blue-600 text-white font-bold py-4 rounded-2xl transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] shadow-lg hover:shadow-emerald-500/50 mt-6"
                >
                    <span class="flex items-center justify-center gap-2">
                        <span>Start Quiz</span>
                        <span class="text-xl">â†’</span>
                    </span>
                </button>
            </div>

            <!-- Quiz Section -->
            <div id="quiz-section" class="hidden space-y-5">
                <!-- Play Sound Button -->
                <div class="flex justify-center">
                    <button 
                        id="play-sound-btn"
                        class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold px-10 py-5 rounded-2xl transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-xl hover:shadow-purple-500/50 text-lg btn-glow relative"
                    >
                        <span id="play-btn-content" class="flex items-center gap-3">
                            <span class="text-2xl">ğŸ”Š</span>
                            <span>Play Sound</span>
                        </span>
                        <span id="loading-spinner" class="hidden absolute inset-0 flex items-center justify-center">
                            <svg class="spinner w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                    </button>
                </div>

                <!-- Answer Input -->
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-300">
                        âœï¸ Your Answer
                    </label>
                    <input 
                        type="number" 
                        id="user-answer" 
                        class="w-full px-5 py-4 bg-gray-700/50 border-2 border-gray-600/50 rounded-2xl text-white text-lg placeholder-gray-500 focus:outline-none focus:border-cyan-500/50 focus:bg-gray-700/70 transition-all duration-300"
                        placeholder="Type the number..."
                    >
                </div>

                <!-- Submit Button -->
                <button 
                    id="submit-btn"
                    class="w-full bg-gradient-to-r from-emerald-500 to-cyan-500 hover:from-emerald-600 hover:to-cyan-600 text-white font-bold py-4 rounded-2xl transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] shadow-lg hover:shadow-cyan-500/50"
                >
                    Check Answer âœ“
                </button>

                <!-- Result Display -->
                <div id="result-section" class="hidden animate-slide-in">
                    <!-- Result Message -->
                    <div id="result-message" class="p-4 rounded-2xl mb-4 text-center font-bold text-lg"></div>
                    
                    <!-- Answer Details Card -->
                    <div class="bg-gradient-to-br from-gray-700/40 to-gray-800/40 backdrop-blur-sm p-5 rounded-2xl space-y-3 border border-gray-600/30">
                        <div class="flex justify-between items-center py-2">
                            <span class="text-gray-400 font-medium">Number:</span>
                            <span id="correct-number" class="font-bold text-xl text-cyan-400"></span>
                        </div>
                        <div class="h-px bg-gray-600/50"></div>
                        <div class="flex justify-between items-center py-2">
                            <span class="text-gray-400 font-medium">Hanzi:</span>
                            <span id="hanzi" class="font-bold text-2xl text-emerald-400"></span>
                        </div>
                        <div class="h-px bg-gray-600/50"></div>
                        <div class="flex justify-between items-center py-2">
                            <span class="text-gray-400 font-medium">Pinyin:</span>
                            <span id="pinyin" class="font-semibold text-gray-200"></span>
                        </div>
                        <div id="user-answer-display" class="hidden">
                            <div class="h-px bg-red-500/30"></div>
                            <div class="flex justify-between items-center py-2">
                                <span class="text-gray-400 font-medium">Your Answer:</span>
                                <span id="user-answer-value" class="font-bold text-xl text-red-400"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Next Button (Floating Right) -->
                    <div class="flex justify-end mt-4">
                        <button 
                            id="next-btn"
                            class="bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-bold px-8 py-3 rounded-2xl transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-lg hover:shadow-blue-500/50"
                        >
                            <span class="flex items-center gap-2">
                                <span>Next</span>
                                <span class="text-lg">â†’</span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Footer -->
        <div id="stats" class="hidden text-center mt-6 text-gray-400 text-sm space-y-1 animate-slide-in">
            <div>Question <span id="question-number" class="text-cyan-400 font-semibold">1</span></div>
            <div>Score: <span id="score" class="text-emerald-400 font-semibold">0</span> / <span id="total" class="text-gray-300">0</span></div>
        </div>
    </div>

    <script is:inline>
        let currentNumber = 0;
        let maxRange = 1000;
        let difficulty = 'easy';
        let questionCount = 0;
        let correctCount = 0;
        let selectedVoice = 'zh-CN-XiaoxiaoNeural';
        let currentAudio = null;

        // Number to Chinese conversion
        function numberToHanzi(num) {
            const digits = ['é›¶', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹'];
            
            if (num === 0) return 'é›¶';
            if (num < 10) return digits[num];
            if (num === 10) return 'å';
            if (num < 20) return 'å' + digits[num % 10];
            if (num < 100) {
                const tens = Math.floor(num / 10);
                const ones = num % 10;
                return digits[tens] + 'å' + (ones > 0 ? digits[ones] : '');
            }
            if (num < 1000) {
                const hundreds = Math.floor(num / 100);
                const remainder = num % 100;
                let result = digits[hundreds] + 'ç™¾';
                if (remainder > 0) {
                    if (remainder < 10) result += 'é›¶';
                    result += numberToHanzi(remainder);
                }
                return result;
            }
            if (num < 10000) {
                const thousands = Math.floor(num / 1000);
                const remainder = num % 1000;
                let result = digits[thousands] + 'åƒ';
                if (remainder > 0) {
                    if (remainder < 100) result += 'é›¶';
                    result += numberToHanzi(remainder);
                }
                return result;
            }
            
            return num.toString();
        }

        function numberToPinyin(num) {
            const digits = ['lÃ­ng', 'yÄ«', 'Ã¨r', 'sÄn', 'sÃ¬', 'wÇ”', 'liÃ¹', 'qÄ«', 'bÄ', 'jiÇ”'];
            
            if (num === 0) return 'lÃ­ng';
            if (num === 10) return 'shÃ­';
            if (num < 20) return 'shÃ­ ' + digits[num % 10];
            if (num < 100) {
                const tens = Math.floor(num / 10);
                const ones = num % 10;
                return digits[tens] + ' shÃ­' + (ones > 0 ? ' ' + digits[ones] : '');
            }
            if (num < 1000) {
                const hundreds = Math.floor(num / 100);
                const remainder = num % 100;
                let result = digits[hundreds] + ' bÇi';
                if (remainder > 0) {
                    if (remainder < 10) result += ' lÃ­ng';
                    result += ' ' + numberToPinyin(remainder);
                }
                return result;
            }
            if (num < 10000) {
                const thousands = Math.floor(num / 1000);
                const remainder = num % 1000;
                let result = digits[thousands] + ' qiÄn';
                if (remainder > 0) {
                    if (remainder < 100) result += ' lÃ­ng';
                    result += ' ' + numberToPinyin(remainder);
                }
                return result;
            }
            
            return num.toString();
        }

        function generateNumber() {
            if (difficulty === 'easy') {
                const options = [10, 20, 50, 100, 200, 500, 1000];
                const filtered = options.filter(n => n <= maxRange);
                return filtered[Math.floor(Math.random() * filtered.length)] || Math.floor(Math.random() * Math.min(100, maxRange)) + 1;
            } else if (difficulty === 'medium') {
                return Math.floor(Math.random() * Math.min(10000, maxRange)) + 100;
            } else {
                return Math.floor(Math.random() * maxRange) + 1;
            }
        }

        // TTS - Convert number to Chinese then speak
        async function speakWithEdgeTTS(number) {
            const playBtn = document.getElementById('play-sound-btn');
            const playBtnContent = document.getElementById('play-btn-content');
            const loadingSpinner = document.getElementById('loading-spinner');
            
            if (playBtn) playBtn.disabled = true;
            if (playBtnContent) playBtnContent.classList.add('invisible');
            if (loadingSpinner) loadingSpinner.classList.remove('hidden');
            
            try {
                // Stop current audio if playing
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }

                // PENTING: Convert ke Chinese text DULU!
                const chineseText = numberToHanzi(number);
                console.log('Speaking Chinese:', chineseText);

                // Map voice selection to TikTok voices
                const voiceMap = {
                    'zh-CN-XiaoxiaoNeural': 'zh_CN_female',
                    'zh-CN-YunxiNeural': 'zh_CN_male',
                    'zh-CN-YunyangNeural': 'zh_CN_male',
                    'zh-CN-XiaoyiNeural': 'zh_CN_female'
                };

                const tiktokVoice = voiceMap[selectedVoice] || 'zh_CN_female';

                // Method 1: Try TikTok TTS API
                try {
                    const response = await fetch(`https://tiktok-tts.weilnet.workers.dev/api/generation`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            text: chineseText,  // Pakai Chinese text!
                            voice: tiktokVoice
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.data && data.data.v_str) {
                            // Convert base64 to audio
                            const audioData = 'data:audio/mp3;base64,' + data.data.v_str;
                            const audio = new Audio(audioData);
                            currentAudio = audio;
                            
                            await audio.play();
                            
                            audio.onended = () => {
                                if (playBtn) playBtn.disabled = false;
                                if (playBtnContent) playBtnContent.classList.remove('invisible');
                                if (loadingSpinner) loadingSpinner.classList.add('hidden');
                            };
                            
                            audio.onerror = () => {
                                console.error('Audio playback error');
                                if (playBtn) playBtn.disabled = false;
                                if (playBtnContent) playBtnContent.classList.remove('invisible');
                                if (loadingSpinner) loadingSpinner.classList.add('hidden');
                            };
                            
                            console.log('TikTok TTS success!');
                            return;
                        }
                    }
                } catch (e) {
                    console.log('TikTok TTS failed:', e);
                }

                // Method 2: Browser SpeechSynthesis fallback (DENGAN CHINESE TEXT!)
                console.log('Using browser fallback with Chinese text');
                
                // Wait for voices to load
                await new Promise((resolve) => {
                    const voices = window.speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        resolve();
                    } else {
                        window.speechSynthesis.onvoiceschanged = () => resolve();
                    }
                });
                
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(chineseText); // Pakai Chinese!
                utterance.lang = 'zh-CN';
                utterance.rate = 0.7;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                // Get available voices and pick Chinese one
                const voices = window.speechSynthesis.getVoices();
                console.log('Available voices:', voices.map(v => `${v.name} (${v.lang})`));
                
                // Try to find best Chinese voice
                const chineseVoice = voices.find(voice => 
                    voice.lang === 'zh-CN' || voice.lang === 'zh-Hans-CN' || voice.lang.startsWith('zh')
                );
                
                if (chineseVoice) {
                    utterance.voice = chineseVoice;
                    console.log('Using voice:', chineseVoice.name, chineseVoice.lang);
                } else {
                    console.warn('No Chinese voice found! Available voices:', voices.length);
                }
                
                utterance.onend = () => {
                    if (playBtn) playBtn.disabled = false;
                    if (playBtnContent) playBtnContent.classList.remove('invisible');
                    if (loadingSpinner) loadingSpinner.classList.add('hidden');
                };
                
                utterance.onerror = (e) => {
                    console.error('Speech error:', e);
                    if (playBtn) playBtn.disabled = false;
                    if (playBtnContent) playBtnContent.classList.remove('invisible');
                    if (loadingSpinner) loadingSpinner.classList.add('hidden');
                };
                
                window.speechSynthesis.speak(utterance);
                
            } catch (error) {
                console.error('TTS Error:', error);
                alert('Audio failed to load. Please try again.');
                if (playBtn) playBtn.disabled = false;
                if (playBtnContent) playBtnContent.classList.remove('invisible');
                if (loadingSpinner) loadingSpinner.classList.add('hidden');
            }
        }

        function updateStats() {
            const questionEl = document.getElementById('question-number');
            const scoreEl = document.getElementById('score');
            const totalEl = document.getElementById('total');
            
            if (questionEl) questionEl.textContent = String(questionCount);
            if (scoreEl) scoreEl.textContent = String(correctCount);
            if (totalEl) totalEl.textContent = String(questionCount);
        }

        // Event Listeners
        const startBtn = document.getElementById('start-btn');
        if (startBtn) {
            startBtn.addEventListener('click', () => {
                const maxRangeInput = document.getElementById('max-range');
                const difficultySelect = document.getElementById('difficulty');
                const voiceSelect = document.getElementById('voice-select');
                
                if (maxRangeInput) maxRange = parseInt(maxRangeInput.value) || 1000;
                if (difficultySelect) difficulty = difficultySelect.value;
                if (voiceSelect) selectedVoice = voiceSelect.value;
                
                const settingsSection = document.getElementById('settings-section');
                const quizSection = document.getElementById('quiz-section');
                const statsSection = document.getElementById('stats');
                
                if (settingsSection) settingsSection.classList.add('hidden');
                if (quizSection) quizSection.classList.remove('hidden');
                if (statsSection) statsSection.classList.remove('hidden');
                
                questionCount = 0;
                correctCount = 0;
                startNewQuestion();
            });
        }

        const playSoundBtn = document.getElementById('play-sound-btn');
        if (playSoundBtn) {
            playSoundBtn.addEventListener('click', () => {
                speakWithEdgeTTS(currentNumber); // Pass number, bukan string!
            });
        }

        const submitBtn = document.getElementById('submit-btn');
        if (submitBtn) {
            submitBtn.addEventListener('click', () => {
                const userAnswerInput = document.getElementById('user-answer');
                const userAnswer = userAnswerInput ? parseInt(userAnswerInput.value) : NaN;
                const isCorrect = userAnswer === currentNumber;
                
                const resultMessage = document.getElementById('result-message');
                const resultSection = document.getElementById('result-section');
                const userAnswerDisplay = document.getElementById('user-answer-display');
                
                if (resultMessage) {
                    if (isCorrect) {
                        correctCount++;
                        resultMessage.className = 'p-4 rounded-2xl mb-4 text-center font-bold text-lg bg-emerald-500/20 text-emerald-300 border-2 border-emerald-500/50';
                        resultMessage.textContent = 'âœ… Correct! Well done!';
                        if (userAnswerDisplay) userAnswerDisplay.classList.add('hidden');
                    } else {
                        resultMessage.className = 'p-4 rounded-2xl mb-4 text-center font-bold text-lg bg-red-500/20 text-red-300 border-2 border-red-500/50';
                        resultMessage.textContent = 'âŒ Not quite right!';
                        const userAnswerValue = document.getElementById('user-answer-value');
                        if (userAnswerValue) {
                            userAnswerValue.textContent = isNaN(userAnswer) ? 'No answer' : String(userAnswer);
                        }
                        if (userAnswerDisplay) userAnswerDisplay.classList.remove('hidden');
                    }
                }
                
                const correctNumberEl = document.getElementById('correct-number');
                const hanziEl = document.getElementById('hanzi');
                const pinyinEl = document.getElementById('pinyin');
                
                if (correctNumberEl) correctNumberEl.textContent = String(currentNumber);
                if (hanziEl) hanziEl.textContent = numberToHanzi(currentNumber);
                if (pinyinEl) pinyinEl.textContent = numberToPinyin(currentNumber);
                
                updateStats();
                if (resultSection) resultSection.classList.remove('hidden');
                if (submitBtn) submitBtn.classList.add('hidden');
            });
        }

        const nextBtn = document.getElementById('next-btn');
        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                startNewQuestion();
            });
        }

        const userAnswerInput = document.getElementById('user-answer');
        if (userAnswerInput) {
            userAnswerInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && submitBtn) {
                    submitBtn.click();
                }
            });
        }

        function startNewQuestion() {
            questionCount++;
            currentNumber = generateNumber();
            
            const userAnswerInput = document.getElementById('user-answer');
            const resultSection = document.getElementById('result-section');
            const submitBtn = document.getElementById('submit-btn');
            
            if (userAnswerInput) userAnswerInput.value = '';
            if (resultSection) resultSection.classList.add('hidden');
            if (submitBtn) submitBtn.classList.remove('hidden');
            if (userAnswerInput) userAnswerInput.focus();
            
            updateStats();
        }
    </script>
</body>
</html>